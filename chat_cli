"""Main CLI module."""

import click
import sys
from rich.console import Console
from rich.panel import Panel
from rich.text import Text
from rich.prompt import Prompt
from src.client import DeepSeekClient


console = Console()


@click.command()
@click.argument('message', required=False)
@click.option('--interactive', '-i', is_flag=True, help='å¯åŠ¨äº¤äº’æ¨¡å¼')
@click.option('--system', '-s', help='ç³»ç»Ÿæç¤ºè¯')
@click.version_option(version='0.1.0')
def cli(message, interactive, system):
    """
    DeepSeek AI å‘½ä»¤è¡ŒèŠå¤©å·¥å…·
    
    ä½¿ç”¨ç¤ºä¾‹:
    
    chat-cli "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±"
    
    chat-cli --interactive  # äº¤äº’æ¨¡å¼
    """
    try:
        client = DeepSeekClient()
    except ValueError as e:
        console.print(f"[red]é”™è¯¯: {e}[/red]")
        console.print("[yellow]è¯·è®¾ç½® DEEPSEEK_API_KEY ç¯å¢ƒå˜é‡[/yellow]")
        console.print("è¯·æŸ¥çœ‹ README.md è·å–é…ç½®è¯´æ˜")
        sys.exit(1)
    except Exception as e:
        console.print(f"[red]åˆå§‹åŒ–å¤±è´¥: {e}[/red]")
        sys.exit(1)
    
    if interactive:
        run_interactive_mode(client, system)
    elif message:
        run_single_message(client, message, system)
    else:
        console.print("è¯·æä¾›æ¶ˆæ¯æˆ–ä½¿ç”¨ --interactive æ¨¡å¼")
        console.print("ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯")


def run_single_message(client: DeepSeekClient, message: str, system_prompt: str = None):
    """è¿è¡Œå•æ¬¡é—®ç­”æ¨¡å¼."""
    try:
        with console.status("[bold green]æ­£åœ¨æ€è€ƒä¸­..."):
            response = client.chat(message, system_prompt)
        
        console.print(Panel(
            Text(response, style="white"),
            title="[bold blue]AI å›ç­”[/bold blue]",
            border_style="blue"
        ))
    except Exception as e:
        console.print(f"[red]é”™è¯¯: {e}[/red]")
        sys.exit(1)


def run_interactive_mode(client: DeepSeekClient, system_prompt: str = None):
    """è¿è¡Œäº¤äº’æ¨¡å¼."""
    console.print("[bold green]ğŸ¤– æ¬¢è¿ä½¿ç”¨ DeepSeek AI èŠå¤©å·¥å…·![/bold green]")
    console.print("[dim]è¾“å…¥ 'quit' æˆ– 'exit' é€€å‡ºï¼Œè¾“å…¥ 'clear' æ¸…ç©ºå¯¹è¯å†å²[/dim]")
    console.print()
    
    # Initialize conversation history
    messages = []
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})
    else:
        messages.append({"role": "system", "content": "You are a helpful assistant"})
    
    while True:
        try:
            user_input = Prompt.ask("[bold cyan]ä½ [/bold cyan]")
            
            if user_input.lower() in ['quit', 'exit', 'é€€å‡º']:
                console.print("[yellow]å†è§ï¼[/yellow]")
                break
            
            if user_input.lower() in ['clear', 'æ¸…ç©º']:
                messages = [messages[0]]  # Keep only system message
                console.print("[yellow]å¯¹è¯å†å²å·²æ¸…ç©º[/yellow]")
                continue
            
            if not user_input.strip():
                continue
            
            messages.append({"role": "user", "content": user_input})
            
            with console.status("[bold green]æ­£åœ¨æ€è€ƒä¸­..."):
                response = client.chat_with_history(messages)
            
            messages.append({"role": "assistant", "content": response})
            
            console.print(Panel(
                Text(response, style="white"),
                title="[bold blue]ğŸ¤– AI[/bold blue]",
                border_style="blue"
            ))
            console.print()
            
        except KeyboardInterrupt:
            console.print("\n[yellow]å†è§ï¼[/yellow]")
            break
        except Exception as e:
            console.print(f"[red]é”™è¯¯: {e}[/red]")
            continue


if __name__ == '__main__':
    cli()
